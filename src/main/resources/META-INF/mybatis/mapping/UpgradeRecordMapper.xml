<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.dounion.server.dao.UpgradeRecordMapper" >

  <resultMap id="BaseResultMap" type="com.dounion.server.entity.UpgradeRecord" >
    <id column="ID" property="id" jdbcType="INTEGER" />
    <result column="SUBSCRIBE_ID" property="subscribeId" jdbcType="INTEGER" />
    <result column="VERSION_ID" property="versionId" jdbcType="INTEGER" />
    <result column="NOTIFY_STATUS" property="notifyStatus" jdbcType="VARCHAR" />
    <result column="NOTIFY_COUNT" property="notifyCount" jdbcType="INTEGER" />
    <result column="NOTIFY_TIME" property="notifyTime" jdbcType="VARCHAR" />
    <result column="UPGRADE_STATUS" property="upgradeStatus" jdbcType="VARCHAR" />
  </resultMap>

  <sql id="Base_Column_List" >
    ID, SUBSCRIBE_ID, VERSION_ID, NOTIFY_STATUS, NOTIFY_COUNT, NOTIFY_TIME, UPGRADE_STATUS
  </sql>

  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    select 
    <include refid="Base_Column_List" />
    from T_UPGRADE_RECORD
    where ID = #{id,jdbcType=INTEGER}
  </select>

  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer" >
    delete from T_UPGRADE_RECORD
    where ID = #{id,jdbcType=INTEGER}
  </delete>

  <insert id="insert" parameterType="com.dounion.server.entity.UpgradeRecord" useGeneratedKeys="true" keyProperty="id">
    insert into T_UPGRADE_RECORD (
        <include refid="Base_Column_List"/>
    ) values (
        #{id,jdbcType=INTEGER},
        #{subscribeId,jdbcType=INTEGER},
        #{versionId,jdbcType=INTEGER},
        #{notifyStatus,jdbcType=VARCHAR},
        #{notifyCount,jdbcType=INTEGER},
        #{notifyTime, jdbcType=VARCHAR},
        #{upgradeStatus,jdbcType=VARCHAR}
      )
  </insert>

  <insert id="insertSelective" parameterType="com.dounion.server.entity.UpgradeRecord"
            useGeneratedKeys="true" keyProperty="id">
    insert into T_UPGRADE_RECORD
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        ID,
      </if>
      <if test="subscribeId != null" >
        SUBSCRIBE_ID,
      </if>
      <if test="versionId != null" >
        VERSION_ID,
      </if>
      <if test="notifyStatus != null" >
        NOTIFY_STATUS,
      </if>
      <if test="notifyCount != null" >
        NOTIFY_COUNT,
      </if>
      <if test="notifyTime != null" >
        NOTIFY_TIME,
      </if>
      <if test="upgradeStatus != null" >
        UPGRADE_STATUS,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=INTEGER},
      </if>
      <if test="subscribeId != null" >
        #{subscribeId,jdbcType=INTEGER},
      </if>
      <if test="versionId != null" >
        #{versionId,jdbcType=INTEGER},
      </if>
      <if test="notifyStatus != null" >
        #{notifyStatus,jdbcType=VARCHAR},
      </if>
      <if test="notifyCount != null" >
        #{notifyCount,jdbcType=INTEGER},
      </if>
      <if test="notifyTime != null" >
        #{notifyTime, jdbcType=VARCHAR},
      </if>
      <if test="upgradeStatus != null" >
        #{upgradeStatus,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>

  <update id="updateByPrimaryKeySelective" parameterType="com.dounion.server.entity.UpgradeRecord" >
    update T_UPGRADE_RECORD
    <set >
      <if test="subscribeId != null" >
        SUBSCRIBE_ID = #{subscribeId,jdbcType=INTEGER},
      </if>
      <if test="versionId != null" >
        VERSION_ID = #{versionId,jdbcType=INTEGER},
      </if>
      <if test="notifyStatus != null" >
        NOTIFY_STATUS = #{notifyStatus,jdbcType=VARCHAR},
      </if>
      <if test="notifyCount != null" >
        NOTIFY_COUNT = #{notifyCount,jdbcType=INTEGER},
      </if>
      <if test="notifyCountStr != null" >
        NOTIFY_COUNT = NOTIFY_COUNT+1,
      </if>
      <if test="notifyTime != null" >
        NOTIFY_TIME = #{notifyTime, jdbcType=VARCHAR},
      </if>
      <if test="upgradeStatus != null" >
        UPGRADE_STATUS = #{upgradeStatus,jdbcType=VARCHAR},
      </if>
    </set>
    where ID = #{id,jdbcType=INTEGER}
  </update>

  <update id="updateByPrimaryKey" parameterType="com.dounion.server.entity.UpgradeRecord" >
    update T_UPGRADE_RECORD
    set SUBSCRIBE_ID = #{subscribeId,jdbcType=INTEGER},
      VERSION_ID = #{versionId,jdbcType=INTEGER},
      NOTIFY_STATUS = #{notifyStatus,jdbcType=VARCHAR},
      NOTIFY_COUNT = #{notifyCount,jdbcType=INTEGER},
      NOTIFY_TIME = #{notifyTime, jdbcType=VARCHAR},
      UPGRADE_STATUS = #{upgradeStatus,jdbcType=VARCHAR}
    where ID = #{id,jdbcType=INTEGER}
  </update>

  <select id="selectListBySelective" parameterType="com.dounion.server.entity.UpgradeRecord"
          resultMap="BaseResultMap">
    SELECT <include refid="Base_Column_List"/>
    FROM T_UPGRADE_RECORD
    <trim prefix="where " prefixOverrides="AND | OR" >
      <if test="subscribeId != null" >
        AND SUBSCRIBE_ID = #{subscribeId,jdbcType=INTEGER}
      </if>
      <if test="versionId != null" >
        AND VERSION_ID = #{versionId,jdbcType=INTEGER}
      </if>
      <if test="notifyStatus != null" >
        AND NOTIFY_STATUS = #{notifyStatus,jdbcType=VARCHAR}
      </if>
      <if test="notifyCount != null" >
        AND NOTIFY_COUNT = #{notifyCount,jdbcType=INTEGER}
      </if>
      <if test="notifyTime != null" >
        AND NOTIFY_TIME = #{notifyTime, jdbcType=VARCHAR}
      </if>
      <if test="upgradeStatus != null" >
        AND UPGRADE_STATUS = #{upgradeStatus,jdbcType=VARCHAR}
      </if>
    </trim>
  </select>


  <select id="publishListQuery" resultType="java.util.HashMap">
        SELECT A.ID AS VERSION_ID,
               A.APP_TYPE,
               A.VERSION_NO,
               A.IS_FORCE_UPDATE,
               A.FILE_NAME,
               A.FILE_PATH,
               A.ADD_SOURCE,
               B.ID AS SUBSCRIBE_ID,
               B.CODE,
               B.OS_TYPE,
               B.IS_STAND_BY,
               B.PUBLISH_URL,
               C.ID AS RECORD_ID
        FROM T_UPGRADE_VERSION_INFO A
            INNER JOIN T_UPGRADE_SUBSCRIBE_INFO B ON A.APP_TYPE = B.APP_TYPE AND B.STATUS = 1
            LEFT JOIN T_UPGRADE_RECORD C ON C.VERSION_ID = A.ID AND C.SUBSCRIBE_ID = B.ID
        WHERE A.STATUS = 1
          AND NOT EXISTS(
                  SELECT 1 FROM T_UPGRADE_RECORD D
                  WHERE D.SUBSCRIBE_ID = B.ID
                    AND D.VERSION_ID = A.ID
                    AND (D.NOTIFY_COUNT >=6 OR D.NOTIFY_STATUS = 1)
              )
  </select>

</mapper>